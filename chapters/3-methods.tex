\documentclass[../main.tex]{subfiles}

\begin{document}

\chapter{Methods}
The process from collecting data to training the \ac{NN} can be divided to 4 steps (see Fig. \ref{fig:process-diagram}): (A) motion lab experiment, (B) filtering and preprocessing EMG data, (C) performing \ac{IK} and \ac{ID} to retrieve knee joint moments as training labels and data preparation before training, and (D) training and testing the network.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.9\textwidth]{img/ProcessDiagram}
    \caption{Flow diagram of the modelling procedure. The dashed box indicates procedure used only for training the \ac{NN} and the dashed arrows are feedback during training. (A) Subject walks in a motion lab collecting \ac{GRF} from force plates, marker trajectories, and muscle activity from \ac{sEMG} sensors; (B) The data is filtered and prepared for use in the models; (C) The \ac{GRF} and marker trajectories are used for \ac{IK} and \ac{ID} to retrieve knee joint moments; (D) During training the normalized \ac{EMG} is continuously fed through the \ac{NN}, the dashed arrows indicate feedback where the output is compared to the moments from (C) and the error used to update the \ac{NN}; (D) Once training is finished the \ac{EMG} can be fed through the \ac{NN} directly, producing knee joint moments to control motor torque in an exoskeleton}
    \label{fig:process-diagram}
\end{figure}

For the experiment (step A), a motion lab equipped with 10 Vicon Vantage V16 cameras and 3 AMTI OR6 \acp{FP} was used. 
The CGM2.3 markerset \textcite{Leboeuf2019} (see Fig. \ref{fig:cgm23-markerset}) was used without optional markers, except for RBAK which was included.
The aktos nano \ac{sEMG} sensors from myon were used for the \ac{EMG} data capture. 
The sensors were placed on the surface near 12 muscles (see table \ref{tab:muscle-names}) using skin preparation and placement recommendations from the SENIAM group \cite{Hermens1999, Hermens2000}.

% \begin{figure}
%     \centering
%     \includegraphics[width=0.9\textwidth]{img/CGM23_markerset3.png}
%     \caption{CGM2.3 markerset protocol}
%     \label{fig:cgm23-markerset}
% \end{figure}
\begin{figure}
     \centering
     \begin{subfigure}[b]{0.5\textwidth}
         \centering
         \includegraphics[width=\textwidth]{img/CGM23_markerset3.png}
         \caption{Figure is adapted from pyCGM2 official website \cite{Leboeuf2019}}
         \label{fig:cgm23-markerset-guidelines}
     \end{subfigure}
     \hfill
     \begin{subfigure}[b]{0.4\textwidth}
         \centering
         \includegraphics[width=\textwidth]{img/experiment_capture2.png}
         \caption{Screenshot is taken from Vicon Nexus during gait trial.}
         \label{fig:cgm23-markerset-experiment-capture}
     \end{subfigure}
    \caption{CGM2.3 marker set as seen from the guidelines (a) and one conducted gait trial (b). Description: (a) Optional markers with red cross were not used and calibration only markers were removed before dynamic trials. (b) The skeleton is built using the CGM2.3 marker set and pyCGM2-CGM2\_3 python scripts in Vicon Nexus 2.8.2. The colored spheres represent the markers. The knee joint center can be seen with its own coordinate system where the x-axis (red) and z-axis (blue) define the sagittal plane in which rotation around the y-axis (green) defines flexion and extension of the knee.}
    \label{fig:cgm23-markerset}
\end{figure}

All the data from the \ac{EMG} sensors (muscle activity), cameras (marker trajectories), and the \acp{FP} (\ac{GRF}) was collected and synchronized using the Vicon Nexus 2.8.2 system/software.
The synchronization includes accounting for the latency of $14ms$ of the \ac{EMG} sensors.
The marker trajectories were sampled at 100Hz using the cameras while the analog data (i.e. \ac{GRF} and \ac{EMG}) was sampled at 1000Hz.

Data was collected on x subjects with anthropometric data measured for each subject (see table \ref{tab:subject-table}).
The subjects were asked to walk front and back over the \acp{FP} either slowly, normally, or fast.
Note that a subject refers to one individual, a trial refers to each experiment performed by the subject, and an exercise refers to each measured exercised performed in the trial. 
Thus, each subject can have many trials (i.e. experiments conducted on separate days), and each trial has many exercises where, for example, walking 10 times results in 10 separate exercises.
Furthermore, each exercise is cut down to gait cycles defined by the interval from the right foots heal strike on a \ac{FP} until its next heal strike.
Some trials included 3 \acp{FP} resulting in some exercises having two gait cycles.
\input{tables/subject-table.tex}

In step B, before running \ac{IK} and \ac{ID}, the marker trajectories and the \ac{GRF} are filtered with a 4th order Butterworth lowpass filter with a cutoff frequency of $10Hz$. 
Same cutoff frequency is used to minimize an artifact introduced in the joint moment at heel strike, due to a spike in reaction force at that time \cite{Kristianslund2012}.
The \ac{EMG} was filtered with the "typical" steps as mentioned by \citeauthor{Clancy2016} \parencite[99]{Clancy2016}, but excluding the whitening step to keep the filtering real-time friendly.
Thus, the signal was noise and interference filtered using Butterworth IIR bandpass filter with cutoff frequencies $10-100Hz$. 
Then, for demodulation, smoothing, and relinearization, the RMS method was used where the smoothing was done with a moving average window of $20ms$. 
As \citeauthor{Clancy2016} point out, it is common to use a window of $100-250 ms$ but for the purpose of keeping the solution real-time friendly $50ms$ is chosen to not introduce too much delay. Furthermore, a little noise in the data is good for reducing overfitting.
Finally, the \ac{EMG} signal is downsampled to match the frequency of the model outputs which is $100Hz$. The downsampling is done by simply taking the first \ac{EMG} sample from every $10ms$ windows. 
The first sample is used rather than any other to decrease the delay from \ac{EMG} to moment prediction. In that way an \ac{EMG} sample taken at $t_{0ms}$ can predict a moment value at $t_{9ms}$. 
% The downsampling is only necessary for the training, not for running the \ac{NN} in real-time.

The pyCGM2 package by \textcite{Leboeuf2019} was used to apply \ac{IK} and \ac{ID} on the motion and force data.
The \ac{ID} computations are based on anthropometric segment measurements according to \textcite{Dempster1955} and the iterative Newton-Euler equations as described by \textcite{Dumas2004}.
The model outputs are designed to have the same conventions as Vicon's \ac{PiG} model, and as such are normalized to the subject's height and body mass \cite{Leboeuf2019, viconpig}.

Before training the network in step D, the \ac{EMG} data and joint moments data was split into training and testing set.
Furthermore, for the purpose of standardizing the data between subjects, the datasets were normalized.
\ac{EMG} is normalized so that all values from the training dataset are between $0$ and $1$, independent of subject.
The normalization is given by equation \ref{eq:emg-normalization}:
\begin{equation}
\label{eq:emg-normalization}
    X_{norm} = \frac{X - X_{min}}{X_{max} - X_{min}}
\end{equation}
where $X$ is the \ac{EMG} value to be normalized and $X_{min}$ and $X_{max}$ are, respectively, the minimum and maximum measured \ac{EMG} from the training dataset. 
The testing dataset uses the same minimum and maximum values, to accurately portray new data that the \ac{NN} does not already "know".
The moments are normalized similar to the \ac{EMG} in equation \ref{eq:emg-normalization} with addition clause to set the interval:
\begin{equation}
\label{eq:moment-normalization}
    X_{norm} = \frac{X - X_{min}}{X_{max} - X_{min}}\left(1 - \frac{X_{min}}{X_{max}}\right) + \frac{X_{min}}{X_{max}}
\end{equation}
where $X$ represents moment values. 
The extra clause makes sure the signal is scaled down to the interval $[-1,1]$ (assuming $\left|X_{min}\right| \leq \left|X_{max}\right|$) and that flexion and extension is still represented with positive and negative values respectively.

TensorFlow \cite{tensorflow2015-whitepaper} and the Keras API \cite{chollet2015keras} were used for constructing and training the \ac{NN}.

% Introduce TensorFlow and the Keras API for the implementation of the \ac{NN}.
% The training set for the \ac{NN} is normalized EMG data from regular walking.
% The training labels are the corresponding joint torque values obtained from Vicon Nexus CGM2.

% \section{Data collection and Inverse Dynamics}
% Before running inverse dynamics on the model, the force plate and trajectory data is filtered. A 4th order Butterworth lowpass filter with a cutoff frequency of $10Hz$ is used here. Same cutoff frequency is used for both the force plate data and the trajectory data to minimize an artifact introduced in the joint moment at heel strike, due to a spike in reaction force at that time \cite{Kristianslund2012}.

% \section{Surface-EMG filtering and feature extraction}
% The filtering steps are \parencite[99]{Clancy2016}:
% \begin{enumerate}
%     \item Noise and interference filtering using Butterworth IIR bandpass filter with cutoff frequencies $10-100Hz$
%     \item Temporal decorrelation (or whitening) to get rid of correlation from neighboring EMG channels
%     \item Demodulation (this could be taking RMS?)
%     \item Smoothing: moving average with a window of $20ms$, i.e. 20 samples. As \citeauthor{Clancy2016} points out, it is common to use a window of $100-250 ms$ but for the purpose of keeping the solution real-time friendly $20ms$ is chosen to not introduce too much delay.
%     \item Relinearization
% \end{enumerate}

% \section{Training of the Neural Network}

\end{document}
